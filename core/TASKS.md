# Crucible Development Tasks

## Current Priority: Iterative Ticket Refinement Feature

**Goal**: Allow users to iteratively refine tickets generated by `c qs` using editor + AI enhancement loops.

**User Story**: "I want to generate a ticket with `c qs`, have the AI enhance it, then edit it in neovim, resubmit to AI for further refinement, and repeat until I'm satisfied, then create the Jira ticket."

---

## **Implementation Roadmap**

### **Phase 1: CLI Infrastructure** 
**Complexity**: Small (1 hour)
**Priority**: High

- [ ] **Add `--iterate` flag support** (core/lib/cli.clj)
  - Extend `parse-flags` function with `--iterate` boolean flag  
  - Update help text to document new flag
  - Test flag parsing with combinations: `--iterate --ai`, `--iterate -e --ai`

**Acceptance Criteria:**
- `c qs --iterate "test"` parses successfully  
- Flag works with existing combinations
- Help text updated

---

### **Phase 2: Core Iteration Loop**
**Complexity**: Medium (2 hours)  
**Priority**: High

- [ ] **Create iterative enhancement system** (core/lib/story_creation.clj)
  - `iterative-enhancement` function with main loop logic
  - `prompt-user-action` for user choices (resubmit/done/edit-again/quit)
  - Integration point in `quick-story-command` workflow
  - Error handling for interrupted iterations

**Implementation Details:**
```clojure
(defn iterative-enhancement
  "Handle iterative AI enhancement with editor loop"  
  [initial-data ai-config]
  (loop [current-data initial-data iteration 1]
    ;; AI enhance → editor → user choice → loop or finish
    ))

(defn prompt-user-action  
  "Prompt user for next action in iterative workflow"
  [edited-data original-data]
  ;; [r] Resubmit, [d] Done, [e] Edit again, [q] Quit
  )
```

**Acceptance Criteria:**
- Loop continues until user chooses 'done' or 'quit'
- Handles editor failures gracefully  
- Preserves data between iterations
- Clear user prompts with validation

---

### **Phase 3: Context-Aware AI Resubmission**
**Complexity**: Medium (2 hours)
**Priority**: Medium

- [ ] **Enhanced AI prompting system** (core/lib/ai.clj)
  - `detect-user-changes` to analyze diffs between iterations
  - `build-iteration-prompt` with progressive context-aware prompts  
  - `resubmit-with-context` preserving user intent
  - Template variable system for iteration context

**Key Innovation**: AI receives context about what user changed and builds on it rather than replacing it.

**Prompting Strategy:**
- **Iteration 1**: Standard enhancement prompt
- **Iteration 2+**: "User made changes X, Y, Z. Refine while preserving their edits."
- **Iteration 3+**: "Focus on polish while keeping all user additions."

**Implementation Details:**
```clojure
(defn detect-user-changes  
  "Detect what user changed between AI output and their edit"
  [ai-version user-version]
  {:title-changed (not= (:title ai-version) (:title user-version))
   :description-changes (diff-text (:description ai-version) (:description user-version))
   :added-sections (find-new-sections ai-version user-version)})

(defn build-iteration-prompt [iteration changes]  
  ;; Progressive prompts based on iteration number and user changes
  )
```

**Acceptance Criteria:**
- AI preserves user additions in subsequent iterations
- Different prompts for different iteration numbers
- Change detection works for title and description modifications  
- Context is meaningful and actionable for AI

---

### **Phase 4: Enhanced Editor Integration**
**Complexity**: Small (1 hour)
**Priority**: Medium  

- [ ] **Iterative editor support** (core/lib/ticket_editor.clj)
  - `open-iterative-editor` with iteration context in comments
  - `create-iterative-template` showing iteration number and status
  - `parse-iterative-content` handling enhanced editor output
  - Draft system integration for iteration recovery

**Editor Template Enhancement:**
```markdown
# Ticket Iteration 2 - AI Enhanced  
# Save and exit to continue iteration
# Commands available: :ItResubmit, :ItDone (if neovim plugin installed)
#
# Previous changes: User added technical analysis section

Title: Fix Authentication Service Login Timeout Issues

Description:
[AI-enhanced content here]
```

**Acceptance Criteria:**
- Editor shows current iteration number
- Comments provide helpful context about previous changes
- Template parsing handles iteration-specific content
- Integration with draft recovery system

---

### **Phase 5: Testing & Documentation**
**Complexity**: Medium (1.5 hours)
**Priority**: High

- [ ] **Integration testing**
  - Test full workflow: initial → AI → edit → resubmit → create  
  - Error scenarios: cancelled iterations, AI failures, editor crashes
  - Edge cases: empty edits, no changes detected, rapid iterations

- [ ] **Documentation updates**  
  - Update docs/jira-guide.md with `--iterate` examples
  - Add troubleshooting section for iteration issues
  - Update setup-guide.md with workflow examples

**Test Scenarios:**
```bash
# Full workflow test
c qs "Fix auth bug" --iterate --ai

# Integration with existing flags  
c qs --iterate -e --ai          # Start with editor
c qs --iterate --ai-only        # AI iteration without ticket creation
c qs --iterate --recover draft  # Iterate existing draft

# Error handling
c qs --iterate --ai  # Then Ctrl+C during editor
c qs --iterate --ai  # Then save empty content
```

**Acceptance Criteria:**
- All test scenarios pass without errors
- Documentation includes clear examples
- Troubleshooting covers common issues
- Error messages are helpful and actionable

---

### **Phase 6: Optional Neovim Enhancement** 
**Complexity**: Small (1 hour)
**Priority**: Low (Nice to have)

- [ ] **Neovim integration script**
  - `:ItResubmit` and `:ItDone` commands
  - Auto-save on idle, buffer-local keybindings  
  - Optional floating window for iteration status
  - Plugin installation instructions

**Neovim Integration:**
```vim
" ~/.config/nvim/plugin/crucible.vim
command! ItResubmit call crucible#resubmit_to_ai()
command! ItDone call crucible#create_ticket()

" Buffer-local mappings for .crucible-ticket files
autocmd FileType markdown.crucible nnoremap <buffer> <leader>ai :ItResubmit<CR>
autocmd FileType markdown.crucible nnoremap <buffer> <leader>done :ItDone<CR>
```

**Acceptance Criteria:**  
- Commands work seamlessly in neovim
- File type detection for .crucible-ticket files
- Installation instructions in documentation
- Optional - doesn't break workflow if not installed

---

## **Overall Acceptance Criteria**

### **Core Workflow Must Work:**
```bash
c qs "Fix auth bug" --iterate --ai
# → AI enhances → opens editor → user edits → prompts for action → repeat until done → creates ticket
```

### **Integration Requirements:**
- **Backward Compatible**: All existing `c qs` functionality unchanged
- **Flag Combinations**: Works with existing flags (`-e`, `--ai`, `--ai-only`, etc.)
- **Draft System**: Integrates with existing draft save/recovery
- **Cross-Platform**: Works with any $EDITOR (enhanced for neovim)

### **User Experience Goals:**
- **Clear Prompts**: User always knows their options  
- **Easy Exit**: Can quit at any point without losing work
- **Context Preservation**: User changes are never lost or undone
- **Progressive Enhancement**: Each iteration improves rather than replaces

### **Technical Requirements:**  
- **Error Handling**: Graceful failure recovery
- **Performance**: No significant slowdown vs existing workflow
- **Maintainability**: Clean separation of concerns, testable functions
- **Documentation**: Clear examples and troubleshooting

---

## **Implementation Notes**

### **Key Design Principles:**
1. **Additive Only**: No breaking changes to existing functionality
2. **User Control**: Clear choices and easy escape paths
3. **Context Preservation**: AI builds on user input, doesn't replace it
4. **Progressive Refinement**: Each iteration should improve quality

### **Risk Mitigation:**
- **Phase 1-2 are core**: Get basic loop working first
- **Phase 3 is the innovation**: Context-aware prompting is key differentiator  
- **Phases 4-6 are polish**: Can be done incrementally
- **Extensive testing**: Complex user interaction flow requires thorough validation

### **Success Metrics:**
- User can complete full iterate → edit → resubmit → create workflow
- AI respects and builds on user changes rather than undoing them
- Clear, intuitive user experience that feels natural
- No regression in existing `c qs` functionality

---

## **Total Effort Estimate**
**7.5 hours** across 6 phases  
**Risk Level**: Low (purely additive feature)  
**Testing Priority**: High (complex user interaction flow)

---

*Last Updated: 2025-09-25*  
*Status: Planning → Implementation*